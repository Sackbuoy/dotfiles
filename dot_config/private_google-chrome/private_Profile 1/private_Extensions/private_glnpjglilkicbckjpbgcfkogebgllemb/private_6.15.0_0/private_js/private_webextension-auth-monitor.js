Okta.AuthenticationMonitor=function(r,i){var t=Okta.Q;var e=Okta._okta;var o=e.delay;var a=e.each;var n=e.find;var u=e.last;var s=Okta.fn.url.getOktaFederatedRequestMatchPatterns;var d=Okta.fn.url.isAllowedOktaRequestForAuthMonitoring;var l=Okta.fn.url.isOktaFederalDomain;var f=false;var c=false;var m=false;var h={};var g=20;var v=2e4;var p={};function b(e){return p[e]}function R(e,t){p[e]=t}function q(e){delete p[e]}function L(e,t){if(!t||!e){return}t.push({url:e.url,startTimeStamp:e.timeStamp});R(e.tabId,t)}function w(e,t){var r=u(t);r.method=e.method;r.statusCode=e.statusCode;r.endTimeStamp=e.timeStamp;r.responseTimeMs=Math.round(r.endTimeStamp-r.startTimeStamp);r.error=e.error;R(e.tabId,t)}function S(n){return t.all([r.getOktaDomain(),r.getVersion(),r.getSessionCookie()]).spread(function(e,t,r){if(!e){Log.warn("Failed to find Okta domain from persistent storage. Not "+"logging interaction");return}if(!t){Log.warn("Failed to find plugin version from persistent storage. Not "+"logging interaction");return}if(!r||!r.sid||!r.DT){Log.warn("Failed to find a valid Okta session. Not logging interaction");return}i.ajax({url:e+"/api/plugin/2/log?plugin_version="+t.backgroundVersion+"-"+t.contentVersion,type:"POST",beforeSend:function(e){e.setRequestHeader("Accept","application/json;charset=utf-8");e.setRequestHeader("Plugin-Sid",r.sid);e.setRequestHeader("X-Session-Id",r.sid);e.setRequestHeader("X-Device-Token",r.DT)},data:{message:n,logLevel:"INFO"}})})}function O(t){return r.getOktaDomain().then(function(e){if(!e){return false}if(!t||!t.url||t.url.indexOf(e)!==0){return false}if(!d(t.url)){return false}return true})}function k(e,t,r){var n="Auth Interaction: ";a(e,function(e,t){e.startTimeStamp=undefined;e.endTimeStamp=undefined;e.url=t===0||m?encodeURI(e.url):undefined});n+=JSON.stringify(e);q(t);if(!r||c){return S(n)}}function T(e){if(!e||!e.transitionQualifiers){return false}if(e.transitionType==="link"&&e.transitionQualifiers.length>0&&e.transitionQualifiers[0]==="server_redirect"){return false}return e.transitionType==="auto_subframe"||!!n(e.transitionQualifiers,function(e){return e==="client_redirect"||e==="server_redirect"})}function I(e){if(!e||!e.transitionQualifiers){return false}return e.transitionType==="typed"||e.transitionType==="auto_bookmark"||e.transitionType==="reload"}function y(){if(!chrome.webRequest.onSendHeaders||!chrome.webRequest.onCompleted||!chrome.webRequest.onBeforeRedirect||!chrome.webRequest.onErrorOccurred||!chrome.webNavigation.onCommitted||!chrome.tabs.onRemoved){Log.warn("AuthenticationMonitor::isSupported: Current version of "+"the browser does not support this functionality");return false}return true}function C(t){return O(t).then(function(e){e&&L(t,[])})}function _(r){return O(r).then(function(e){if(!e){return}var t=b(r.tabId);if(!t||t.length===0){return}w(r,t);if(r.statusCode>=400||r.error){k(t,r.tabId,false);return}})}function A(e){var t=b(e.tabId);if(!t||t.length===0){return}if(t.length===1&&t[0].url===e.url){return}L(e,t)}function H(t){var e=b(t.tabId);if(!e||e.length===0){return}var r=e.length;if(r===1&&e[0].url===t.url){return}if(r===2&&t.method!=="POST"){q(t.tabId);return}var n=u(e);if(n.url!==t.url){L({timeStamp:n.endTimeStamp,url:t.url},e);n=u(e);r++}if(r===g){n.oktaError="request queue reached maximum capacity of "+g+" web requests"}w(t,e);if(t.statusCode>=400||t.error||r===g){return k(e,t.tabId,false)}if((t.method==="GET"||t.method==="POST")&&t.statusCode<300){o(function(){var e=b(t.tabId);if(!e){return}if(e.length>r){return}k(e,t.tabId,true)},v)}}function M(e){var t=b(e.tabId);if(!t||t.length<=2){return}if(I(e)){q(e.tabId);return}if(!T(e)){t.pop();return k(t,e.tabId,true)}}function D(e){q(e)}function E(){if(!f){Log.info("AuthenticationMonitor::removeRequestListeners: "+"no listeners are attached to be removed");return}chrome.webRequest.onSendHeaders.removeListener(C);chrome.webRequest.onCompleted.removeListener(_);chrome.webRequest.onErrorOccurred.removeListener(_);chrome.webRequest.onSendHeaders.removeListener(A);chrome.webRequest.onBeforeRedirect.removeListener(H);chrome.webRequest.onCompleted.removeListener(H);chrome.webRequest.onErrorOccurred.removeListener(H);chrome.webNavigation.onCommitted.removeListener(M);chrome.tabs.onRemoved.removeListener(D);f=false;Log.info("AuthenticationMonitor::removeRequestListeners: "+"removed all listeners")}function F(){if(f){Log.info("AuthenticationMonitor::addRequestListeners: "+"listeners already attached");return}var e=s();chrome.webRequest.onSendHeaders.addListener(C,{urls:e},["requestHeaders"]);chrome.webRequest.onCompleted.addListener(_,{urls:e});chrome.webRequest.onErrorOccurred.addListener(_,{urls:e});chrome.webRequest.onSendHeaders.addListener(A,{urls:["<all_urls>"],types:["main_frame"]},["requestHeaders"]);chrome.webRequest.onBeforeRedirect.addListener(H,{urls:["<all_urls>"],types:["main_frame"]});chrome.webRequest.onCompleted.addListener(H,{urls:["<all_urls>"],types:["main_frame"]});chrome.webRequest.onErrorOccurred.addListener(H,{urls:["<all_urls>"],types:["main_frame"]});chrome.webNavigation.onCommitted.addListener(M);chrome.tabs.onRemoved.addListener(D);f=true;Log.info("AuthenticationMonitor::addRequestListeners: "+"added all listeners")}h.initialize=function(e){c=!!e;if(!y()){return}return t.all([r.getPluginSettings(),r.getOktaDomain()]).spread(function(e,t){if(e&&e.orgSettings&&e.orgSettings.pluginAuthFailureDetectionEnabled&&!l(t)){F();m=e.orgSettings.pluginAuthFailureDetectionShowUrlEnabled;return}Log.info("AuthenticationMonitor::initialize: Auth monitoring feature "+"is disabled or on federal org");E();return})};return h};